# ═══════════════════════════════════════════════════
# BErozgar — Nginx Configuration (Production)
# ═══════════════════════════════════════════════════
#
# Mounted as /etc/nginx/nginx.conf inside the nginx container.
# Responsibilities:
#   - SSL termination (TLS 1.2 + 1.3)
#   - HTTP → HTTPS redirect
#   - Reverse-proxy /api → Fastify backend
#   - Serve Vite SPA with cache-busted assets
#   - Gzip compression
#   - Security headers (CSP, HSTS, X-Frame, etc.)
#   - Edge rate limiting (10 req/s per IP on /api)
#   - CORS enforcement locked to frontend origin

user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
    multi_accept        on;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # ── Logging ─────────────────────────────────────
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      'rt=$request_time';
    access_log  /var/log/nginx/access.log  main;

    # ── Performance ─────────────────────────────────
    sendfile           on;
    tcp_nopush         on;
    tcp_nodelay        on;
    keepalive_timeout  65;
    types_hash_max_size 2048;

    # ── Security baseline ───────────────────────────
    server_tokens  off;                 # hide "nginx/1.x" from responses
    client_max_body_size  5m;           # max upload size

    # ── Gzip ────────────────────────────────────────
    gzip             on;
    gzip_vary        on;
    gzip_proxied     any;
    gzip_comp_level  6;
    gzip_min_length  256;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        text/javascript
        image/svg+xml
        application/wasm;

    # ── Rate limiting zones ─────────────────────────
    # 10 requests/sec per IP for API endpoints
    limit_req_zone  $binary_remote_addr  zone=api_limit:10m   rate=10r/s;
    # 2 requests/sec per IP for auth (login/signup/otp)
    limit_req_zone  $binary_remote_addr  zone=auth_limit:10m  rate=2r/s;

    # ── Upstream backend ────────────────────────────
    upstream api_backend {
        server  api:3001;
        keepalive  32;
    }

    # ── Map for CORS origin validation ──────────────
    # Only the exact production origin gets CORS headers
    map $http_origin $cors_origin {
        default          "";
        "https://berozgar.in"      "https://berozgar.in";
        "https://www.berozgar.in"  "https://www.berozgar.in";
    }

    # ═════════════════════════════════════════════════
    # Server: HTTP → HTTPS redirect
    # ═════════════════════════════════════════════════
    server {
        listen       80;
        listen       [::]:80;
        server_name  berozgar.in www.berozgar.in;

        # Certbot / ACME challenge (must work over HTTP)
        location /.well-known/acme-challenge/ {
            root  /var/www/certbot;
        }

        # Everything else → HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ═════════════════════════════════════════════════
    # Server: HTTPS — main entry point
    # ═════════════════════════════════════════════════
    server {
        listen       443 ssl http2;
        listen       [::]:443 ssl http2;
        server_name  berozgar.in www.berozgar.in;

        # ── SSL certificates ────────────────────────
        ssl_certificate      /etc/nginx/certs/fullchain.pem;
        ssl_certificate_key  /etc/nginx/certs/privkey.pem;

        # ── Modern TLS configuration ────────────────
        ssl_protocols        TLSv1.2 TLSv1.3;
        ssl_ciphers          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
        ssl_prefer_server_ciphers  off;
        ssl_session_timeout  1d;
        ssl_session_cache    shared:SSL:10m;
        ssl_session_tickets  off;

        # OCSP stapling
        ssl_stapling         on;
        ssl_stapling_verify  on;
        resolver             8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout     5s;

        # ── Security headers (applied to all responses) ──
        add_header  X-Frame-Options           "SAMEORIGIN"                              always;
        add_header  X-Content-Type-Options    "nosniff"                                 always;
        add_header  X-XSS-Protection          "0"                                       always;
        add_header  Referrer-Policy           "strict-origin-when-cross-origin"          always;
        add_header  Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        add_header  Permissions-Policy        "camera=(), microphone=(), geolocation=(), payment=()" always;
        add_header  Content-Security-Policy   "default-src 'self'; script-src 'self' 'unsafe-inline' https://accounts.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob: https:; connect-src 'self' https://accounts.google.com; frame-src https://accounts.google.com; base-uri 'self'; form-action 'self'; frame-ancestors 'self';" always;

        # ── /api — reverse proxy to Fastify ─────────
        location /api/ {
            limit_req  zone=api_limit  burst=20  nodelay;

            # CORS at edge (only whitelisted origins)
            add_header  Access-Control-Allow-Origin       $cors_origin  always;
            add_header  Access-Control-Allow-Methods      "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header  Access-Control-Allow-Headers      "Authorization, Content-Type, X-Idempotency-Key, X-CSRF-Token" always;
            add_header  Access-Control-Allow-Credentials  "true"        always;
            add_header  Access-Control-Max-Age            "86400"       always;

            # Preflight
            if ($request_method = 'OPTIONS') {
                add_header  Access-Control-Allow-Origin       $cors_origin  always;
                add_header  Access-Control-Allow-Methods      "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
                add_header  Access-Control-Allow-Headers      "Authorization, Content-Type, X-Idempotency-Key, X-CSRF-Token" always;
                add_header  Access-Control-Allow-Credentials  "true"        always;
                add_header  Access-Control-Max-Age            "86400"       always;
                add_header  Content-Length                     0;
                add_header  Content-Type                      "text/plain";
                return 204;
            }

            proxy_pass         http://api_backend;
            proxy_http_version 1.1;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   Connection        "";

            # Timeouts
            proxy_connect_timeout  10s;
            proxy_send_timeout     30s;
            proxy_read_timeout     30s;

            # Don't buffer API responses (SSE / streaming friendly)
            proxy_buffering  off;
        }

        # ── /api/auth — stricter rate limit ──────────
        location /api/auth/ {
            limit_req  zone=auth_limit  burst=5  nodelay;

            proxy_pass         http://api_backend;
            proxy_http_version 1.1;
            proxy_set_header   Host              $host;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   Connection        "";
            proxy_connect_timeout  10s;
            proxy_send_timeout     30s;
            proxy_read_timeout     30s;
            proxy_buffering  off;
        }

        # ── /health — passthrough (no rate limit, no access log) ──
        location /health {
            proxy_pass         http://api_backend/health;
            proxy_http_version 1.1;
            proxy_set_header   Connection  "";
            access_log  off;
        }

        # ── Static SPA ──────────────────────────────
        location / {
            root   /usr/share/nginx/html;
            index  index.html;

            # SPA fallback — serve index.html for client-side routes
            try_files  $uri  $uri/  /index.html;

            # Cache hashed assets aggressively (Vite adds content hash)
            location ~* \.(js|css|woff2?|ttf|eot|otf|png|jpe?g|gif|webp|avif|ico|svg|wasm)$ {
                expires     1y;
                add_header  Cache-Control  "public, immutable";
                access_log  off;
            }

            # Never cache the SPA entry point
            location = /index.html {
                expires     -1;
                add_header  Cache-Control  "no-cache, no-store, must-revalidate";
                add_header  Pragma         "no-cache";
            }
        }

        # ── Block dotfiles (except .well-known) ─────
        location ~ /\. {
            deny  all;
            access_log   off;
            log_not_found off;
        }
    }
}
