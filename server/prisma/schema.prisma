// BErozgar — Production Database Schema
// PostgreSQL 15+ via Prisma ORM
// Phase 2+: Full integrity. UUID PKs, snake_case columns, FK cascades.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════
// Enums
// ═══════════════════════════════════════════════════

enum UserRole {
  STUDENT
  ADMIN
}

enum PrivilegeLevel {
  STANDARD
  SUPER
}

// ListingStatus maps 1:1 to ListingMachine states
enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  INTEREST_RECEIVED
  IN_TRANSACTION
  COMPLETED
  EXPIRED
  FLAGGED
  ARCHIVED
  REMOVED
}

// RequestStatus maps 1:1 to RequestMachine states
enum RequestStatus {
  IDLE
  SENT
  ACCEPTED
  DECLINED
  MEETING_SCHEDULED
  COMPLETED
  EXPIRED
  CANCELLED
  WITHDRAWN
  DISPUTED
  RESOLVED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  REJECTED
  ESCALATED
}

enum DisputeType {
  FRAUD
  ITEM_NOT_AS_DESCRIBED
  NO_SHOW
  OTHER
}

// ═══════════════════════════════════════════════════
// Users
// ═══════════════════════════════════════════════════

model User {
  id                 String         @id @default(uuid()) @db.Uuid
  googleId           String?        @unique @map("google_id")
  email              String         @unique
  fullName           String         @map("full_name")
  password           String?        // null for Google-only accounts
  role               UserRole       @default(STUDENT)
  privilegeLevel     PrivilegeLevel @default(STANDARD) @map("privilege_level")
  trustStatus        String         @default("GOOD_STANDING") @map("trust_status")
  verified           Boolean        @default(false)
  avatarUrl          String?        @map("avatar_url")

  // Restriction state
  isRestricted       Boolean  @default(false) @map("is_restricted")
  restrictionReason  String?  @map("restriction_reason")

  completedExchanges Int      @default(0) @map("completed_exchanges")
  cancelledRequests  Int      @default(0) @map("cancelled_requests")
  adminFlags         Int      @default(0) @map("admin_flags")

  // Account lockout — 5 failed logins → 15 min lockout
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt    @map("updated_at")

  // Relations
  listings         Listing[]
  buyerRequests    Request[]      @relation("BuyerRequests")
  sellerRequests   Request[]      @relation("SellerRequests")
  disputes         Dispute[]      @relation("RaisedDisputes")
  disputesAgainst  Dispute[]      @relation("AgainstDisputes")
  auditLogs        AuditLog[]     @relation("AuditActor")
  refreshTokens    RefreshToken[]
  otps             Otp[]

  @@index([email])
  @@index([role])
  @@map("users")
}

// ═══════════════════════════════════════════════════
// Auth — Refresh Tokens (server-side rotation)
// ═══════════════════════════════════════════════════

model RefreshToken {
  id              String    @id @default(uuid()) @db.Uuid
  token           String    @unique @db.VarChar(64) // SHA-256 hex hash
  userId          String    @map("user_id") @db.Uuid
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt       DateTime  @map("expires_at")
  revokedAt       DateTime? @map("revoked_at")
  replacedByToken String?   @map("replaced_by_token") @db.VarChar(64)
  userAgent       String?   @map("user_agent")
  ipAddress       String?   @map("ip_address") @db.VarChar(45)
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}

// ═══════════════════════════════════════════════════
// Auth — OTP Verification
// ═══════════════════════════════════════════════════

model Otp {
  id        String    @id @default(uuid()) @db.Uuid
  email     String
  code      String
  userId    String?   @map("user_id") @db.Uuid
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([email, code])
  @@map("otps")
}

// ═══════════════════════════════════════════════════
// Listings
// ═══════════════════════════════════════════════════

model Listing {
  id          String        @id @default(uuid()) @db.Uuid
  ownerId     String        @map("owner_id") @db.Uuid
  owner       User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  title       String
  description String?
  category    String?
  module      String?       // Academic module / course code
  price       Decimal       @default(0) @db.Decimal(12, 2)
  status      ListingStatus @default(DRAFT)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt    @map("updated_at")

  // Relations
  requests Request[]
  disputes Dispute[]  @relation("DisputeListing")

  @@index([ownerId])
  @@index([status])
  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@map("listings")
}

// ═══════════════════════════════════════════════════
// Requests (Exchange Lifecycle)
// ═══════════════════════════════════════════════════

model Request {
  id        String        @id @default(uuid()) @db.Uuid
  listingId String        @map("listing_id") @db.Uuid
  listing   Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  buyerId   String        @map("buyer_id") @db.Uuid
  buyer     User          @relation("BuyerRequests", fields: [buyerId], references: [id])
  sellerId  String        @map("seller_id") @db.Uuid
  seller    User          @relation("SellerRequests", fields: [sellerId], references: [id])
  status    RequestStatus @default(IDLE)
  version   Int           @default(0) // Optimistic locking counter

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt    @map("updated_at")

  // Relations
  disputes Dispute[]

  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("requests")
}

// ═══════════════════════════════════════════════════
// Disputes
// ═══════════════════════════════════════════════════

model Dispute {
  id          String        @id @default(uuid()) @db.Uuid
  requestId   String?       @map("request_id") @db.Uuid
  request     Request?      @relation(fields: [requestId], references: [id])
  listingId   String?       @map("listing_id") @db.Uuid
  listing     Listing?      @relation("DisputeListing", fields: [listingId], references: [id])
  raisedById  String        @map("raised_by") @db.Uuid
  raisedBy    User          @relation("RaisedDisputes", fields: [raisedById], references: [id])
  againstId   String        @map("against_id") @db.Uuid
  against     User          @relation("AgainstDisputes", fields: [againstId], references: [id])
  type        DisputeType
  description String
  status      DisputeStatus @default(OPEN)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([raisedById])
  @@index([againstId])
  @@index([status])
  @@map("disputes")
}

// ═══════════════════════════════════════════════════
// Audit Log
// ═══════════════════════════════════════════════════

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  actorId    String   @map("actor_id") @db.Uuid
  actor      User     @relation("AuditActor", fields: [actorId], references: [id])
  action     String
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id") @db.Uuid
  actorRole  String?  @map("actor_role")
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  metadata   Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([actorId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ═══════════════════════════════════════════════════
// Idempotency Keys
// ═══════════════════════════════════════════════════

model IdempotencyKey {
  id             String   @id @default(uuid()) @db.Uuid
  key            String   @unique
  userId         String   @map("user_id") @db.Uuid
  responseStatus Int      @map("response_status")
  responseBody   Json     @map("response_body")
  expiresAt      DateTime @map("expires_at")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([key, userId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}
